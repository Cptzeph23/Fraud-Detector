{% extends 'base.html' %}
{% block title %}Submit Transaction{% endblock %}
{% block content %}
<div class="container">
    <h2 class="mb-4 text-center">Submit a Transaction for Scoring</h2>
    <div class="card shadow-sm">
        <div class="card-body">
            <form id="transactionForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Phone Number (2547...)</label>
                    <input type="text" class="form-control" id="phone" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount (KES)</label>
                    <input type="number" class="form-control" id="amount" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Merchant ID</label>
                    <input type="text" class="form-control" id="merchant_id">
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Transaction</button>
            </form>
        </div>
    </div>
    <div id="result" class="alert mt-4 d-none"></div>
</div>
<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
document.getElementById("transactionForm").addEventListener("submit", function(e) {
    e.preventDefault();
    fetch("/transactions/create/", {
        method: "POST",
        headers: {"Content-Type": "application/json", "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value},
        body: JSON.stringify({
            phone: document.getElementById("phone").value,
            amount: document.getElementById("amount").value,
            merchant_id: document.getElementById("merchant_id").value
        })
    })
    .then(res => res.json())
    .then(data => {
        const alertBox = document.getElementById("result");
        alertBox.classList.remove("d-none","alert-danger","alert-success");
        if (data.status === "FLAGGED") {
            alertBox.classList.add("alert-danger");
            alertBox.innerText = "⚠️ Fraudulent transaction detected!";
        } else if (data.status === "PENDING") {
            alertBox.classList.add("alert-info");
            alertBox.innerText = "✔️ Transaction submitted and awaiting payment confirmation (STK Push sent).";
        } else {
            alertBox.classList.add("alert-success");
            alertBox.innerText = "✔️ Transaction processed.";
        }
    }).catch(e => {
        const alertBox = document.getElementById("result");
        alertBox.classList.remove("d-none");
        alertBox.classList.add("alert-danger");
        alertBox.innerText = "An error occurred: " + e;
    });
});
</script>
{% endblock %}
